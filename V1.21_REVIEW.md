# Orbital Temple V1.21 - Code Review Summary
**Date:** 2025-12-16 | **Status:** Ready for Testing | **Launch:** T-25 days

> **Update:** Added radiation protection (TMR + CRC) for SEU mitigation in space

---

## Critical Bugs Fixed (Would Have Caused Mission Failure)

| Bug | Impact | Fix |
|-----|--------|-----|
| **Sensor variables shadowed** | All telemetry showed ZEROS | Removed local variable declarations in `sensors.cpp` |
| **Duplicate function definitions** | LoRa receive broken after TX | Single definition in `config.cpp` |
| **Inconsistent sync word** | Ground station couldn't reach satellite | Unified to `LORA_SYNC_WORD` (0x12) |

---

## Security Added

- **HMAC-SHA256 authentication** on all commands
- **Input validation** (delimiter check, path traversal blocked, length limits)
- **Command format:** `SAT_ID-COMMAND&PATH@DATA#HMAC`

**ACTION REQUIRED:** Change HMAC key in `config.cpp:17-22` before flight!

---

## Reliability Improvements

| Feature | Benefit |
|---------|---------|
| **Watchdog timer** (60s) | Auto-restart if code hangs |
| **Non-blocking state machine** | Satellite responds during deployment wait |
| **State persistence** (EEPROM) | Survives reboots, won't re-deploy antenna |
| **Retry mechanisms** | Radio failures don't brick satellite |
| **SD capacity monitoring** | Telemetry shows `SD:XX%`, writes rejected when full |
| **Radiation protection** | TMR + CRC32 protects against SEU bit flips |

---

## Radiation Protection (NEW)

Protection against Single Event Upsets (SEUs) from charged particles in space:

| Technique | Protection |
|-----------|------------|
| **Triple Modular Redundancy (TMR)** | Critical variables stored 3x with 2-of-3 voting |
| **CRC32 checksums** | EEPROM data verified on boot |
| **Periodic scrubbing** | Every 60 seconds, TMR checked/corrected |

**Protected variables:** mission state, antenna state, boot count, hardware flags

**Telemetry:** SEU count included (`SEU:N`)

**New command:** `GetRadStatus` - returns total SEU corrections

---

## Adaptive Beacon System (NEW)

| Contact Status | Beacon Interval |
|----------------|-----------------|
| Before first contact | **1 minute** |
| After contact established | **1 hour** |
| No contact 24+ hours | **5 minutes** |

Configure in `config.h:137-140`

---

## Ground Station Updates Required

1. Add HMAC signature to all commands
2. Update command parser for new format
3. Handle new telemetry format: `T+HH:MM:SS|sensors|data`

---

## Pre-Flight Checklist

- [ ] Change HMAC key
- [ ] Compile without errors
- [ ] Verify telemetry shows real sensor values
- [ ] Test beacon reception
- [ ] Test invalid command rejection
- [ ] 7-day soak test
- [ ] Thermal test (-40°C to +85°C)

---

## File Structure

```
V_1.21/main/
├── main.ino        # Entry point
├── config.h/cpp    # Configuration, HMAC, beacon
├── setup.cpp       # Init + watchdog
├── loop.cpp        # State machine + commands
├── lora.cpp        # Radio (single setFlag definition)
├── sensors.cpp     # FIXED variable shadowing
├── memor.cpp       # SD card operations
├── radiation.h/cpp # NEW: SEU protection (TMR + CRC)
└── id.cpp          # Satellite ID
```

**Total: ~2,700 lines | 17 files**

---

## V1.2 vs V1.21 Comparison

| Aspect | V1.2 | V1.21 |
|--------|------|-------|
| Telemetry | Broken (zeros) | Working |
| Security | None | HMAC auth |
| Watchdog | None | 60s timeout |
| Blocking delays | 5-20 min unresponsive | Non-blocking |
| State persistence | None | EEPROM + CRC |
| Beacon | Fixed interval | Adaptive |
| Radiation protection | None | TMR + CRC32 |

---

**Full changelog:** `V_1.21/CHANGELOG.md`

*Ad Astra*
